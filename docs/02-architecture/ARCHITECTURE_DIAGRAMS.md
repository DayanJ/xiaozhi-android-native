# Android AI Assistant 架构图

## 🏗️ 整体架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                        Android AI Assistant                     │
├─────────────────────────────────────────────────────────────────┤
│  UI Layer (Activities & Fragments)                              │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ │
│  │MainActivity │ │ChatActivity │ │VoiceCall    │ │Settings     │ │
│  │             │ │             │ │Activity     │ │Activity     │ │
│  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘ │
├─────────────────────────────────────────────────────────────────┤
│  ViewModel Layer (State Management)                             │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐                │
│  │Conversation │ │Config       │ │Theme        │                │
│  │ViewModel    │ │ViewModel    │ │ViewModel    │                │
│  └─────────────┘ └─────────────┘ └─────────────┘                │
├─────────────────────────────────────────────────────────────────┤
│  Service Layer (Business Logic)                                 │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐                │
│  │DifyService  │ │XiaozhiService│ │AudioUtil    │                │
│  │(HTTP API)   │ │(WebSocket)   │ │(Audio)      │                │
│  └─────────────┘ └─────────────┘ └─────────────┘                │
├─────────────────────────────────────────────────────────────────┤
│  Repository Layer (Data Access)                                 │
│  ┌─────────────┐ ┌─────────────┐                                │
│  │Conversation │ │Config       │                                │
│  │Repository   │ │Repository   │                                │
│  └─────────────┘ └─────────────┘                                │
├─────────────────────────────────────────────────────────────────┤
│  Data Layer (Database & Network)                                │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐                │
│  │Room         │ │OkHttp       │ │WebSocket    │                │
│  │Database     │ │(HTTP)       │ │(Real-time)  │                │
│  └─────────────┘ └─────────────┘ └─────────────┘                │
└─────────────────────────────────────────────────────────────────┘
```

## 🔄 数据流架构图

### 对话数据流
```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│   User      │───►│   UI        │───►│  ViewModel  │───►│ Repository  │
│  Action     │    │ (Activity)  │    │ (LiveData)  │    │ (Data)      │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
       ▲                   ▲                   ▲                   │
       │                   │                   │                   ▼
       │                   │                   │            ┌─────────────┐
       │                   │                   │            │  Database   │
       │                   │                   │            │   (Room)    │
       │                   │                   │            └─────────────┘
       │                   │                   │                   │
       │                   │                   │                   ▼
       │                   │                   │            ┌─────────────┐
       │                   │                   │            │   Entity    │
       │                   │                   │            │  (Table)    │
       │                   │                   │            └─────────────┘
       │                   │                   │                   │
       │                   │                   │                   ▼
       │                   │                   │            ┌─────────────┐
       │                   │                   │            │    DAO      │
       │                   │                   │            │ (Database   │
       │                   │                   │            │ Operations) │
       │                   │                   │            └─────────────┘
       │                   │                   │                   │
       │                   │                   │                   ▼
       │                   │                   │            ┌─────────────┐
       │                   │                   │            │   Model     │
       │                   │                   │            │ (Business   │
       │                   │                   │            │  Object)    │
       │                   │                   │            └─────────────┘
       │                   │                   │                   │
       │                   │                   │                   ▼
       │                   │                   │            ┌─────────────┐
       │                   │                   │            │ Repository  │
       │                   │                   │            │ (Data       │
       │                   │                   │            │  Access)    │
       │                   │                   │            └─────────────┘
       │                   │                   │                   │
       │                   │                   │                   ▼
       │                   │                   │            ┌─────────────┐
       │                   │                   │            │  ViewModel  │
       │                   │                   │            │ (State      │
       │                   │                   │            │ Management) │
       │                   │                   │            └─────────────┘
       │                   │                   │                   │
       │                   │                   │                   ▼
       │                   │                   │            ┌─────────────┐
       │                   │                   │            │     UI      │
       │                   │                   │            │ (Activity)  │
       │                   │                   │            └─────────────┘
       │                   │                   │                   │
       │                   │                   │                   ▼
       │                   │                   │            ┌─────────────┐
       │                   │                   │            │   User      │
       │                   │                   │            │ (Display)   │
       │                   │                   │            └─────────────┘
```

### 消息发送流
```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│   User      │───►│ChatActivity │───►│   Service   │───►│   Network   │
│  Input      │    │ (UI)        │    │ (Business)  │    │ (HTTP/WS)   │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
       ▲                   ▲                   ▲                   │
       │                   │                   │                   ▼
       │                   │                   │            ┌─────────────┐
       │                   │                   │            │   Server    │
       │                   │                   │            │ (Response)  │
       │                   │                   │            └─────────────┘
       │                   │                   │                   │
       │                   │                   │                   ▼
       │                   │                   │            ┌─────────────┐
       │                   │                   │            │   Service   │
       │                   │                   │            │ (Process)   │
       │                   │                   │            └─────────────┘
       │                   │                   │                   │
       │                   │                   │                   ▼
       │                   │                   │            ┌─────────────┐
       │                   │                   │            │  ViewModel  │
       │                   │                   │            │ (Update)    │
       │                   │                   │            └─────────────┘
       │                   │                   │                   │
       │                   │                   │                   ▼
       │                   │                   │            ┌─────────────┐
       │                   │                   │            │     UI      │
       │                   │                   │            │ (Display)   │
       │                   │                   │            └─────────────┘
```

### 语音通话流
```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│   User      │───►│VoiceCall    │───►│XiaozhiService│───►│WebSocket    │
│  Voice      │    │Activity     │    │ (Audio)      │    │ (Real-time) │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
       ▲                   ▲                   ▲                   │
       │                   │                   │                   ▼
       │                   │                   │            ┌─────────────┐
       │                   │                   │            │   Server    │
       │                   │                   │            │ (Audio)     │
       │                   │                   │            └─────────────┘
       │                   │                   │                   │
       │                   │                   │                   ▼
       │                   │                   │            ┌─────────────┐
       │                   │                   │            │XiaozhiService│
       │                   │                   │            │ (Process)   │
       │                   │                   │            └─────────────┘
       │                   │                   │                   │
       │                   │                   │                   ▼
       │                   │                   │            ┌─────────────┐
       │                   │                   │            │  AudioUtil  │
       │                   │                   │            │ (Play)      │
       │                   │                   │            └─────────────┘
       │                   │                   │                   │
       │                   │                   │                   ▼
       │                   │                   │            ┌─────────────┐
       │                   │                   │            │   Speaker   │
       │                   │                   │            │ (Output)    │
       │                   │                   │            └─────────────┘
```

## 🎨 UI界面关系图

```
┌─────────────────────────────────────────────────────────────────┐
│                        MainActivity                             │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐                │
│  │对话列表      │ │创建新对话    │ │设置入口      │                │
│  │显示         │ │按钮         │ │按钮         │                │
│  └─────────────┘ └─────────────┘ └─────────────┘                │
└─────────────────────────────────────────────────────────────────┘
           │                   │                   │
           ▼                   ▼                   ▼
┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐
│ConversationType │ │   ChatActivity  │ │SettingsActivity │
│Activity         │ │                 │ │                 │
│(对话类型选择)    │ │(聊天界面)        │ │(设置界面)        │
└─────────────────┘ └─────────────────┘ └─────────────────┘
           │                   │                   │
           ▼                   ▼                   ▼
┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐
│ConfigSelection  │ │VoiceCallActivity│ │ConfigSelector   │
│Activity         │ │                 │ │Activity         │
│(配置选择)        │ │(语音通话)        │ │(配置管理)        │
└─────────────────┘ └─────────────────┘ └─────────────────┘
           │                   │                   │
           ▼                   ▼                   ▼
┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐
│   ChatActivity  │ │   AudioUtil     │ │ConfigEdit       │
│   (开始聊天)     │ │   (音频处理)     │ │Activity         │
│                 │ │                 │ │(配置编辑)        │
└─────────────────┘ └─────────────────┘ └─────────────────┘
```

## 🔧 服务层架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                        Service Layer                           │
├─────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐                │
│  │DifyService  │ │XiaozhiService│ │AudioUtil    │                │
│  │             │ │             │ │             │                │
│  │• HTTP API   │ │• WebSocket  │ │• Audio      │                │
│  │• 图片上传    │ │• 语音流     │ │• 录制/播放   │                │
│  │• 流式响应    │ │• 消息分发    │ │• Opus编解码  │                │
│  └─────────────┘ └─────────────┘ └─────────────┘                │
├─────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐ ┌─────────────┐                                │
│  │XiaozhiWebSocket│ │Completer   │                                │
│  │Manager      │ │             │                                │
│  │             │ │             │                                │
│  │• 连接管理    │ │• 异步完成    │                                │
│  │• 重连机制    │ │• 超时处理    │                                │
│  │• 心跳保活    │ │• 错误处理    │                                │
│  └─────────────┘ └─────────────┘                                │
└─────────────────────────────────────────────────────────────────┘
```

## 🗄️ 数据库架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                        Room Database                           │
├─────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐                │
│  │Conversation │ │   Message   │ │   Config    │                │
│  │Entity       │ │   Entity    │ │   Entity    │                │
│  │             │ │             │ │             │                │
│  │• id         │ │• id         │ │• id         │                │
│  │• title      │ │• content    │ │• name       │                │
│  │• type       │ │• role       │ │• apiKey     │                │
│  │• configId   │ │• imageUrl   │ │• baseUrl    │                │
│  │• isPinned   │ │• createdAt  │ │• isDefault  │                │
│  └─────────────┘ └─────────────┘ └─────────────┘                │
├─────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐                │
│  │Conversation │ │   Message   │ │   Config    │                │
│  │DAO          │ │   DAO       │ │   DAO       │                │
│  │             │ │             │ │             │                │
│  │• insert     │ │• insert     │ │• insert     │                │
│  │• update     │ │• update     │ │• update     │                │
│  │• delete     │ │• delete     │ │• delete     │                │
│  │• getAll     │ │• getByConv  │ │• getAll     │                │
│  └─────────────┘ └─────────────┘ └─────────────┘                │
└─────────────────────────────────────────────────────────────────┘
```

## 🔄 状态管理架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                        ViewModel Layer                         │
├─────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐                │
│  │Conversation │ │Config       │ │Theme        │                │
│  │ViewModel    │ │ViewModel    │ │ViewModel    │                │
│  │             │ │             │ │             │                │
│  │• conversations│ │• difyConfigs│ │• currentTheme│                │
│  │• messages   │ │• xiaozhiConfigs│ │• isDarkMode │                │
│  │• isLoading  │ │• selectedConfig│ │• themeColors│                │
│  │• error      │ │• isDefault  │ │• fontSize   │                │
│  └─────────────┘ └─────────────┘ └─────────────┘                │
├─────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐ ┌─────────────┐                                │
│  │Repository   │ │LiveData     │                                │
│  │             │ │             │                                │
│  │• 数据访问    │ │• 状态观察    │                                │
│  │• 业务逻辑    │ │• UI更新      │                                │
│  │• 缓存管理    │ │• 生命周期    │                                │
│  └─────────────┘ └─────────────┘                                │
└─────────────────────────────────────────────────────────────────┘
```

## 🌐 网络架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                        Network Layer                           │
├─────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐                │
│  │   HTTP      │ │  WebSocket  │ │   Audio     │                │
│  │   (Dify)    │ │  (Xiaozhi)  │ │   Stream    │                │
│  │             │ │             │ │             │                │
│  │• OkHttp     │ │• OkHttp     │ │• MediaRecorder│                │
│  │• Retrofit   │ │• WebSocket  │ │• AudioTrack │                │
│  │• Gson       │ │• JSON       │ │• Opus       │                │
│  │• 图片上传    │ │• 实时消息    │ │• 音频编解码  │                │
│  └─────────────┘ └─────────────┘ └─────────────┘                │
├─────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐ ┌─────────────┐                                │
│  │   Server    │ │   Client    │                                │
│  │             │ │             │                                │
│  │• Dify API   │ │• Android    │                                │
│  │• Xiaozhi    │ │• App        │                                │
│  │• WebSocket  │ │• Device     │                                │
│  └─────────────┘ └─────────────┘                                │
└─────────────────────────────────────────────────────────────────┘
```

## 🎯 快速定位修改点流程图

```
┌─────────────────────────────────────────────────────────────────┐
│                    修改需求分析                                  │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                    确定修改类型                                  │
└─────────────────────────────────────────────────────────────────┘
                                │
                ┌───────────────┼───────────────┐
                ▼               ▼               ▼
┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐
│   UI界面修改     │ │  业务逻辑修改    │ │  数据模型修改    │
│                 │ │                 │ │                 │
│ • Activity      │ │ • Service       │ │ • Model         │
│ • Layout        │ │ • ViewModel     │ │ • Entity        │
│ • Adapter       │ │ • Repository    │ │ • DAO           │
└─────────────────┘ └─────────────────┘ └─────────────────┘
                │               │               │
                ▼               ▼               ▼
┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐
│   定位文件       │ │   定位文件       │ │   定位文件       │
│                 │ │                 │ │                 │
│ • ui/目录       │ │ • service/目录   │ │ • model/目录     │
│ • res/layout/   │ │ • viewmodel/目录 │ │ • database/目录  │
│ • res/values/   │ │ • repository/目录│ │ • dao/目录       │
└─────────────────┘ └─────────────────┘ └─────────────────┘
                │               │               │
                ▼               ▼               ▼
┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐
│   修改步骤       │ │   修改步骤       │ │   修改步骤       │
│                 │ │                 │ │                 │
│ 1. 修改布局      │ │ 1. 修改服务逻辑   │ │ 1. 修改数据模型   │
│ 2. 修改Activity │ │ 2. 修改ViewModel │ │ 2. 修改数据库    │
│ 3. 修改适配器    │ │ 3. 修改Repository│ │ 3. 修改DAO      │
│ 4. 测试界面      │ │ 4. 测试业务逻辑   │ │ 4. 测试数据操作   │
└─────────────────┘ └─────────────────┘ └─────────────────┘
```

## 📱 应用生命周期图

```
┌─────────────────────────────────────────────────────────────────┐
│                    Application Lifecycle                       │
├─────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐                │
│  │   onCreate  │ │  onStart    │ │  onResume   │                │
│  │             │ │             │ │             │                │
│  │• 初始化      │ │• 可见       │ │• 可交互      │                │
│  │• 绑定数据    │ │• 开始观察    │ │• 恢复连接    │                │
│  │• 设置监听    │ │• 更新UI     │ │• 恢复音频    │                │
│  └─────────────┘ └─────────────┘ └─────────────┘                │
├─────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐                │
│  │  onPause    │ │  onStop     │ │ onDestroy   │                │
│  │             │ │             │ │             │                │
│  │• 暂停连接    │ │• 不可见      │ │• 清理资源    │                │
│  │• 暂停音频    │ │• 停止观察    │ │• 断开连接    │                │
│  │• 保存状态    │ │• 保存数据    │ │• 释放内存    │                │
│  └─────────────┘ └─────────────┘ └─────────────┘                │
└─────────────────────────────────────────────────────────────────┘
```

---

这些架构图帮助开发者快速理解项目的整体结构、数据流向、组件关系，以及如何定位和修改代码。通过可视化的方式，新手可以更容易地掌握项目的架构设计。
