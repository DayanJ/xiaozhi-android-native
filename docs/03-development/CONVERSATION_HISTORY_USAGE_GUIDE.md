# 对话历史功能使用指南

## 功能概述

现在应用已经支持完整的对话历史功能，用户可以：
- 保存所有对话会话和消息到本地数据库
- 在主界面查看历史对话列表
- 点击历史对话继续之前的对话
- 自动保存新消息到数据库

## 使用步骤

### 1. 创建新对话

1. **打开应用**：启动AI助手应用
2. **点击"+"按钮**：在主界面右下角点击浮动按钮
3. **选择对话类型**：
   - **Dify对话**：直接创建新的Dify对话
   - **小智对话**：需要先选择小智配置，然后创建对话
4. **开始聊天**：系统自动创建对话并保存到数据库

### 2. 查看历史对话

1. **主界面显示**：打开应用后，主界面会显示所有历史对话
2. **对话信息**：每个对话显示：
   - 对话标题
   - 最后一条消息预览
   - 最后消息时间
   - 对话类型图标
   - 未读消息数量（如果有）
   - 置顶状态（如果已置顶）

### 3. 继续历史对话

1. **点击对话**：在主界面点击任意历史对话
2. **自动加载**：系统自动加载该对话的所有历史消息
3. **继续聊天**：可以继续发送消息，新消息会自动保存

### 4. 管理对话

#### 4.1 置顶对话
- **操作**：长按对话项
- **效果**：置顶的对话会显示在列表顶部
- **标识**：置顶的对话会显示置顶图标

#### 4.2 删除对话
- **操作**：长按对话项，选择删除
- **效果**：删除对话及其所有消息
- **恢复**：可以恢复最后删除的对话

#### 4.3 标记已读
- **自动**：点击对话时自动标记为已读
- **效果**：未读消息数量清零

## 界面说明

### 主界面
- **对话列表**：显示所有历史对话
- **排序规则**：置顶对话在前，其他按时间倒序
- **空状态**：没有对话时显示提示信息
- **浮动按钮**：点击创建新对话

### 聊天界面
- **消息列表**：显示当前对话的所有消息
- **历史消息**：自动加载并显示历史消息
- **新消息**：自动保存到数据库
- **实时更新**：消息列表实时更新

### 对话类型选择界面
- **Dify对话**：直接创建
- **小智对话**：需要选择配置
- **继续对话**：支持继续现有对话

## 技术特性

### 1. 数据持久化
- **Room数据库**：使用Android Room数据库存储数据
- **自动保存**：所有消息自动保存到数据库
- **离线访问**：无需网络即可查看历史对话

### 2. 响应式更新
- **实时同步**：数据变化时UI自动更新
- **Flow支持**：使用Kotlin Flow进行数据观察
- **LiveData集成**：与Android LiveData无缝集成

### 3. 用户体验
- **无缝切换**：在对话间无缝切换
- **快速加载**：历史消息快速加载
- **直观操作**：简单直观的操作方式

## 数据存储

### 对话数据
- **对话ID**：唯一标识符
- **对话标题**：显示名称
- **对话类型**：Dify或小智
- **配置ID**：关联的配置
- **最后消息**：最后一条消息内容
- **最后时间**：最后消息时间
- **未读数量**：未读消息数量
- **置顶状态**：是否置顶

### 消息数据
- **消息ID**：唯一标识符
- **对话ID**：所属对话
- **角色**：用户或助手
- **内容**：消息内容
- **时间戳**：发送时间
- **已读状态**：是否已读
- **图片信息**：图片相关数据
- **文件信息**：文件相关数据

## 注意事项

### 1. 数据安全
- **本地存储**：所有数据存储在设备本地
- **数据备份**：建议定期备份重要对话
- **隐私保护**：数据不会上传到服务器

### 2. 性能优化
- **分页加载**：大量消息时支持分页加载
- **内存管理**：自动管理内存使用
- **数据库优化**：使用索引优化查询性能

### 3. 兼容性
- **Android版本**：支持Android 5.0及以上版本
- **设备兼容**：支持各种Android设备
- **数据迁移**：支持数据迁移和升级

## 故障排除

### 1. 对话不显示
- **检查数据库**：确认数据库正常初始化
- **重启应用**：尝试重启应用
- **清除缓存**：清除应用缓存

### 2. 消息不保存
- **检查权限**：确认应用有存储权限
- **检查空间**：确认设备有足够存储空间
- **查看日志**：检查应用日志

### 3. 性能问题
- **清理数据**：删除不需要的对话
- **重启应用**：重启应用释放内存
- **更新应用**：使用最新版本

## 总结

对话历史功能已经完全实现，提供了完整的对话管理体验：

✅ **创建对话**：支持创建新的Dify和小智对话
✅ **保存消息**：自动保存所有消息到数据库
✅ **查看历史**：在主界面查看所有历史对话
✅ **继续对话**：点击历史对话继续聊天
✅ **管理对话**：支持置顶、删除、标记已读
✅ **实时更新**：数据变化时UI自动更新

现在用户可以享受完整的对话历史功能，不再需要每次都重新开始对话！
