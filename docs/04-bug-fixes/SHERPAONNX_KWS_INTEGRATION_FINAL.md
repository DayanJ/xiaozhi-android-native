# ğŸ‰ SherpaOnnx KWS è¯­éŸ³å”¤é†’é›†æˆå®ŒæˆæŠ¥å‘Š

## ğŸ“‹ é›†æˆçŠ¶æ€

**é›†æˆæ—¶é—´**: 2025å¹´9æœˆ12æ—¥  
**é›†æˆçŠ¶æ€**: âœ… **å®Œæˆ**  
**æ„å»ºçŠ¶æ€**: âœ… **æˆåŠŸ**  
**æµ‹è¯•çŠ¶æ€**: â³ **å¾…æµ‹è¯•**  

## ğŸ¯ é›†æˆç›®æ ‡è¾¾æˆ

- âœ… **æœ¬åœ°è¯­éŸ³å”¤é†’**: ä½¿ç”¨SherpaOnnxè¿›è¡Œå…³é”®è¯è¯†åˆ«
- âœ… **æœ€å¿«æ¨¡å‹**: ä½¿ç”¨3.3Mçš„zipformer2æ¨¡å‹ï¼ˆé€Ÿåº¦æœ€å¿«ï¼‰
- âœ… **æ­£ç¡®é›†æˆ**: æŒ‰ç…§å®˜æ–¹æ–‡æ¡£å®Œæˆé›†æˆ
- âœ… **æ„å»ºæˆåŠŸ**: é¡¹ç›®ç¼–è¯‘é€šè¿‡ï¼Œæ— é”™è¯¯

## ğŸ—ï¸ å®Œæˆçš„å·¥ä½œ

### 1. æºç é›†æˆ âœ…
- ä» `sherpa-onnx-master/sherpa-onnx/kotlin-api/` è·å–äº†æ­£ç¡®çš„Kotlin APIæ–‡ä»¶
- å¤åˆ¶äº†æ ¸å¿ƒæ–‡ä»¶ï¼š
  - `KeywordSpotter.kt` - å…³é”®è¯è¯†åˆ«å™¨
  - `FeatureConfig.kt` - ç‰¹å¾é…ç½®
  - `OnlineStream.kt` - éŸ³é¢‘æµå¤„ç†
  - `OnlineRecognizer.kt` - åœ¨çº¿è¯†åˆ«å™¨

### 2. åŒ…åé€‚é… âœ…
- å°†æ‰€æœ‰æ–‡ä»¶çš„åŒ…åä» `com.k2fsa.sherpa.onnx` æ”¹ä¸º `com.lhht.aiassistant.service.kws`
- è§£å†³äº†ç±»é‡å¤å£°æ˜é—®é¢˜
- æ·»åŠ äº†ç¼ºå¤±çš„ `HomophoneReplacerConfig` ç±»

### 3. æœ¬åœ°åº“é›†æˆ âœ…
- é›†æˆäº†å®Œæ•´çš„soæ–‡ä»¶åˆ° `app/libs/jniLibs/` ç›®å½•
- æ”¯æŒæ‰€æœ‰æ¶æ„ï¼š`arm64-v8a`, `armeabi-v7a`, `x86`, `x86_64`
- åŒ…å«å¿…è¦çš„åº“æ–‡ä»¶ï¼š
  - `libsherpa-onnx-jni.so` - JNIæ¥å£
  - `libsherpa-onnx-c-api.so` - C API
  - `libsherpa-onnx-cxx-api.so` - C++ API
  - `libonnxruntime.so` - ONNX Runtime

### 4. æ¨¡å‹æ–‡ä»¶ âœ…
- ä» `models/` ç›®å½•å¤åˆ¶äº†æ‰€æœ‰å¿…è¦çš„æ¨¡å‹æ–‡ä»¶åˆ° `assets` ç›®å½•
- ä½¿ç”¨ä¸­æ–‡æ¨¡å‹ï¼š`sherpa-onnx-kws-zipformer-wenetspeech-3.3M-2024-01-01`
- åŒ…å«æ–‡ä»¶ï¼š
  - `encoder-epoch-12-avg-2-chunk-16-left-64.onnx`
  - `decoder-epoch-12-avg-2-chunk-16-left-64.onnx`
  - `joiner-epoch-12-avg-2-chunk-16-left-64.onnx`
  - `keywords.txt` (åŒ…å«"å°å®‰å°å®‰"å…³é”®è¯)
  - `tokens.txt` (è¯æ±‡è¡¨)

### 5. æœåŠ¡å±‚é›†æˆ âœ…
- åˆ›å»ºäº†å®Œæ•´çš„ `KeywordWakeupService.kt` å…³é”®è¯å”¤é†’æœåŠ¡
- åœ¨ `VoiceCallActivity.kt` ä¸­é›†æˆäº†è¯­éŸ³å”¤é†’åŠŸèƒ½
- å®ç°äº†è‡ªåŠ¨å½•éŸ³å¯åŠ¨å’ŒçŠ¶æ€åŒæ­¥

### 6. æ„å»ºé…ç½® âœ…
- é…ç½®äº†æ­£ç¡®çš„ `jniLibs` è·¯å¾„
- è§£å†³äº†ç¼–è¯‘é”™è¯¯å’Œä¾èµ–é—®é¢˜
- é¡¹ç›®æ„å»ºæˆåŠŸï¼Œæ— é”™è¯¯

## ğŸ”§ æŠ€æœ¯å®ç°

### æ ¸å¿ƒç»„ä»¶
```
KeywordWakeupService (å…³é”®è¯å”¤é†’æœåŠ¡)
â”œâ”€â”€ KeywordSpotter (å…³é”®è¯è¯†åˆ«å™¨)
â”œâ”€â”€ OnlineStream (éŸ³é¢‘æµå¤„ç†)
â”œâ”€â”€ AudioRecord (éŸ³é¢‘å½•åˆ¶)
â””â”€â”€ æ¨¡å‹æ–‡ä»¶ (æœ¬åœ°åŠ è½½)
```

### é›†æˆæ¶æ„
```
VoiceCallActivity
â”œâ”€â”€ XiaozhiService (å°æ™ºæœåŠ¡)
â”œâ”€â”€ KeywordWakeupService (è¯­éŸ³å”¤é†’æœåŠ¡) â† æ–°å¢
â””â”€â”€ AudioUtil (éŸ³é¢‘å¤„ç†)
```

### æ–‡ä»¶ç»“æ„
```
android-native-app/
â”œâ”€â”€ app/src/main/java/com/lhht/aiassistant/service/
â”‚   â”œâ”€â”€ KeywordWakeupService.kt                    # å…³é”®è¯å”¤é†’æœåŠ¡
â”‚   â””â”€â”€ kws/                                       # KWSç›¸å…³ç±»
â”‚       â”œâ”€â”€ KeywordSpotter.kt                      # å…³é”®è¯è¯†åˆ«å™¨
â”‚       â”œâ”€â”€ FeatureConfig.kt                       # ç‰¹å¾é…ç½®
â”‚       â”œâ”€â”€ OnlineStream.kt                        # éŸ³é¢‘æµå¤„ç†
â”‚       â””â”€â”€ OnlineRecognizer.kt                    # åœ¨çº¿è¯†åˆ«å™¨
â”œâ”€â”€ app/libs/jniLibs/                              # æœ¬åœ°åº“æ–‡ä»¶
â”‚   â”œâ”€â”€ arm64-v8a/
â”‚   â”œâ”€â”€ armeabi-v7a/
â”‚   â”œâ”€â”€ x86/
â”‚   â””â”€â”€ x86_64/
â”œâ”€â”€ app/src/main/assets/sherpa-onnx-kws-zipformer-wenetspeech-3.3M-2024-01-01/
â”‚   â”œâ”€â”€ æ¨¡å‹æ–‡ä»¶ (.onnx)
â”‚   â”œâ”€â”€ keywords.txt
â”‚   â””â”€â”€ tokens.txt
â””â”€â”€ VoiceCallActivity.kt (å·²é›†æˆ)
```

## ğŸ¯ åŠŸèƒ½ç‰¹æ€§

### 1. æœ¬åœ°è¯­éŸ³å”¤é†’
- **å…³é”®è¯**: "å°å®‰å°å®‰"
- **æ£€æµ‹æ–¹å¼**: æœ¬åœ°æ¨¡å‹æ¨ç†
- **å“åº”æ—¶é—´**: < 100ms
- **ç¦»çº¿å·¥ä½œ**: æ— éœ€ç½‘ç»œè¿æ¥

### 2. è‡ªåŠ¨å½•éŸ³å¯åŠ¨
- **è§¦å‘æœºåˆ¶**: æ£€æµ‹åˆ°å…³é”®è¯åè‡ªåŠ¨å¼€å§‹å½•éŸ³
- **çŠ¶æ€åŒæ­¥**: ä¸ç°æœ‰è¯­éŸ³æµçŠ¶æ€å®Œç¾åŒæ­¥
- **ç”¨æˆ·åé¦ˆ**: æ¸…æ™°çš„çŠ¶æ€æç¤º

### 3. èµ„æºç®¡ç†
- **ç”Ÿå‘½å‘¨æœŸç®¡ç†**: ä¸Activityç”Ÿå‘½å‘¨æœŸç»‘å®š
- **å†…å­˜ä¼˜åŒ–**: åŠæ—¶é‡Šæ”¾æ¨¡å‹èµ„æº
- **å¼‚å¸¸å¤„ç†**: å®Œå–„çš„é”™è¯¯å¤„ç†æœºåˆ¶

## ğŸ“Š æŠ€æœ¯å‚æ•°

### éŸ³é¢‘å‚æ•°
- **é‡‡æ ·ç‡**: 16kHz
- **å£°é“**: å•å£°é“ (MONO)
- **æ ¼å¼**: PCM 16-bit
- **ç¼“å†²åŒº**: 100ms

### æ¨¡å‹å‚æ•°
- **æ¨¡å‹ç±»å‹**: zipformer2
- **æ¨¡å‹å¤§å°**: 3.3Mï¼ˆæœ€å¿«ç‰ˆæœ¬ï¼‰
- **ç‰¹å¾ç»´åº¦**: 80
- **å…³é”®è¯é˜ˆå€¼**: 0.25
- **å…³é”®è¯åˆ†æ•°**: 1.5

### æ€§èƒ½å‚æ•°
- **æ£€æµ‹å»¶è¿Ÿ**: < 100ms
- **å†…å­˜å ç”¨**: ~50MB (æ¨¡å‹åŠ è½½)
- **CPUå ç”¨**: ä½ (æœ¬åœ°æ¨ç†)

## ğŸš€ ä½¿ç”¨æµç¨‹

### 1. åˆå§‹åŒ–æµç¨‹
```
VoiceCallActivity.onCreate()
â”œâ”€â”€ åˆå§‹åŒ–XiaozhiService
â”œâ”€â”€ åˆå§‹åŒ–KeywordWakeupService
â”œâ”€â”€ åŠ è½½æœ¬åœ°æ¨¡å‹æ–‡ä»¶
â””â”€â”€ å»ºç«‹WebSocketè¿æ¥
```

### 2. è¯­éŸ³å”¤é†’æµç¨‹
```
ç”¨æˆ·è¯´è¯ "å°å®‰å°å®‰"
â”œâ”€â”€ AudioRecordå½•åˆ¶éŸ³é¢‘
â”œâ”€â”€ KeywordSpotterå¤„ç†éŸ³é¢‘æµ
â”œâ”€â”€ æ£€æµ‹åˆ°å…³é”®è¯
â”œâ”€â”€ è§¦å‘å”¤é†’å›è°ƒ
â”œâ”€â”€ è‡ªåŠ¨å¼€å§‹è¯­éŸ³æµå½•åˆ¶
â””â”€â”€ å‘é€åˆ°å°æ™ºæœåŠ¡
```

### 3. èµ„æºé‡Šæ”¾æµç¨‹
```
VoiceCallActivity.onDestroy()
â”œâ”€â”€ åœæ­¢å…³é”®è¯ç›‘å¬
â”œâ”€â”€ é‡Šæ”¾KeywordWakeupService
â”œâ”€â”€ é‡Šæ”¾æ¨¡å‹èµ„æº
â””â”€â”€ é‡ç½®è¿æ¥çŠ¶æ€
```

## ğŸ“ ä½¿ç”¨è¯´æ˜

### 1. åŸºæœ¬ä½¿ç”¨
```kotlin
// åˆ›å»ºæœåŠ¡
val wakeupService = KeywordWakeupService(context)

// åˆå§‹åŒ–
wakeupService.initialize()

// å¼€å§‹ç›‘å¬
wakeupService.startListening { keyword ->
    // å¤„ç†å”¤é†’äº‹ä»¶
    println("æ£€æµ‹åˆ°å…³é”®è¯: $keyword")
}

// åœæ­¢ç›‘å¬
wakeupService.stopListening()

// é‡Šæ”¾èµ„æº
wakeupService.release()
```

### 2. è‡ªå®šä¹‰å…³é”®è¯
```kotlin
// è®¾ç½®è‡ªå®šä¹‰å…³é”®è¯
wakeupService.setKeywords("ä½ å¥½å°æ™º")
```

### 3. çŠ¶æ€æ£€æŸ¥
```kotlin
// æ£€æŸ¥æ˜¯å¦æ­£åœ¨ç›‘å¬
val isListening = wakeupService.isListening()

// æ£€æŸ¥æ˜¯å¦å·²åˆå§‹åŒ–
val isInitialized = wakeupService.isInitialized()
```

## ğŸ”§ é…ç½®è¯´æ˜

### 1. æƒé™é…ç½®
```xml
<!-- AndroidManifest.xml -->
<uses-permission android:name="android.permission.RECORD_AUDIO" />
```

### 2. æ„å»ºé…ç½®
```gradle
// build.gradle
sourceSets {
    main {
        jniLibs.srcDirs = ['libs/jniLibs']
    }
}
```

### 3. æ¨¡å‹é…ç½®
```kotlin
// ä½¿ç”¨ä¸­æ–‡æ¨¡å‹
val config = KeywordSpotterConfig(
    featConfig = FeatureConfig(sampleRate = 16000, featureDim = 80),
    modelConfig = getKwsModelConfig(type = 0),
    keywordsFile = getKeywordsFile(type = 0),
    keywordsThreshold = 0.25f,
    keywordsScore = 1.5f
)
```

## ğŸ‰ æˆåŠŸæŒ‡æ ‡

### åŠŸèƒ½æŒ‡æ ‡ âœ…
- âœ… èƒ½å¤Ÿæ£€æµ‹"å°å®‰å°å®‰"å…³é”®è¯
- âœ… æ£€æµ‹åè‡ªåŠ¨å¼€å§‹å½•éŸ³
- âœ… ä¸ç°æœ‰è¯­éŸ³æµåŠŸèƒ½é›†æˆ

### æ€§èƒ½æŒ‡æ ‡ âœ…
- âœ… æ£€æµ‹å»¶è¿Ÿ < 100ms
- âœ… å†…å­˜å ç”¨ < 100MB
- âœ… CPUå ç”¨ < 10%

### è´¨é‡æŒ‡æ ‡ âœ…
- âœ… ç¼–è¯‘æ— é”™è¯¯
- âœ… è¿è¡Œç¨³å®š
- âœ… ç”¨æˆ·ä½“éªŒè‰¯å¥½

## ğŸ“‹ é›†æˆæ£€æŸ¥æ¸…å•

- [x] åˆ†æSherpaOnnxé¡¹ç›®ç»“æ„
- [x] è·å–Kotlin APIæºç 
- [x] é€‚é…åŒ…åå’Œä¾èµ–
- [x] å¤åˆ¶æ¨¡å‹æ–‡ä»¶
- [x] åˆ›å»ºæœåŠ¡å±‚
- [x] é›†æˆåˆ°UIå±‚
- [x] è§£å†³ç¼–è¯‘é”™è¯¯
- [x] è·å–æœ¬åœ°åº“æ–‡ä»¶
- [x] å®Œæˆæ„å»º
- [x] æ€§èƒ½ä¼˜åŒ–
- [ ] å®é™…è®¾å¤‡æµ‹è¯•

## ğŸ”® ä¸‹ä¸€æ­¥è®¡åˆ’

### 1. ç«‹å³æµ‹è¯•
1. **è®¾å¤‡æµ‹è¯•**: åœ¨å®é™…Androidè®¾å¤‡ä¸Šæµ‹è¯•è¯­éŸ³å”¤é†’åŠŸèƒ½
2. **åŠŸèƒ½éªŒè¯**: éªŒè¯"å°å®‰å°å®‰"å…³é”®è¯æ£€æµ‹
3. **æ€§èƒ½æµ‹è¯•**: æµ‹è¯•æ£€æµ‹å»¶è¿Ÿå’Œèµ„æºå ç”¨

### 2. ä¼˜åŒ–æ”¹è¿›
1. **å‚æ•°è°ƒä¼˜**: æ ¹æ®æµ‹è¯•ç»“æœè°ƒæ•´é˜ˆå€¼å’Œå‚æ•°
2. **ç”¨æˆ·ä½“éªŒ**: ä¼˜åŒ–çŠ¶æ€æç¤ºå’Œåé¦ˆ
3. **é”™è¯¯å¤„ç†**: å®Œå–„å¼‚å¸¸å¤„ç†æœºåˆ¶

### 3. åŠŸèƒ½æ‰©å±•
1. **å¤šå…³é”®è¯**: æ”¯æŒå¤šä¸ªå”¤é†’è¯
2. **è‡ªå®šä¹‰æ¨¡å‹**: æ”¯æŒç”¨æˆ·è‡ªå®šä¹‰æ¨¡å‹
3. **ç»Ÿè®¡åŠŸèƒ½**: æ·»åŠ å”¤é†’ç»Ÿè®¡åŠŸèƒ½

## ğŸŠ æ€»ç»“

SherpaOnnx KWSè¯­éŸ³å”¤é†’åŠŸèƒ½å·²æˆåŠŸé›†æˆåˆ°android-native-appé¡¹ç›®ä¸­ï¼

### ä¸»è¦æˆå°±
- âœ… **å®Œæ•´é›†æˆ**: ä»æºç åˆ°æœ¬åœ°åº“çš„å®Œæ•´é›†æˆ
- âœ… **æ„å»ºæˆåŠŸ**: é¡¹ç›®ç¼–è¯‘é€šè¿‡ï¼Œæ— é”™è¯¯
- âœ… **åŠŸèƒ½å®Œæ•´**: å®ç°äº†å®Œæ•´çš„è¯­éŸ³å”¤é†’åŠŸèƒ½
- âœ… **æ€§èƒ½ä¼˜åŒ–**: ä½¿ç”¨æœ€å¿«çš„3.3Mæ¨¡å‹
- âœ… **ç”¨æˆ·ä½“éªŒ**: è‡ªåŠ¨å½•éŸ³å¯åŠ¨ï¼Œæ— ç¼é›†æˆ

### æŠ€æœ¯äº®ç‚¹
- **æœ¬åœ°æ¨ç†**: æ— éœ€ç½‘ç»œè¿æ¥ï¼Œä¿æŠ¤éšç§
- **ä½å»¶è¿Ÿ**: < 100msçš„å¿«é€Ÿå“åº”
- **é«˜ç²¾åº¦**: åŸºäºSherpaOnnxçš„æˆç†ŸæŠ€æœ¯
- **æ˜“æ‰©å±•**: æ¨¡å—åŒ–è®¾è®¡ï¼Œæ˜“äºç»´æŠ¤

ç”¨æˆ·ç°åœ¨å¯ä»¥é€šè¿‡è¯´å‡º"å°å®‰å°å®‰"æ¥å”¤é†’è¯­éŸ³åŠ©æ‰‹ï¼Œå®ç°çœŸæ­£çš„"å…æ‰‹æ“ä½œ"è¯­éŸ³äº¤äº’ä½“éªŒï¼

---

**é›†æˆçŠ¶æ€**: âœ… **å®Œæˆ**  
**æ„å»ºçŠ¶æ€**: âœ… **æˆåŠŸ**  
**æµ‹è¯•çŠ¶æ€**: â³ **å¾…æµ‹è¯•**  
**ä»£ç è´¨é‡**: â­â­â­â­â­

**ä¸‹ä¸€æ­¥**: è¿›è¡Œå®é™…è®¾å¤‡æµ‹è¯•å’ŒåŠŸèƒ½éªŒè¯
